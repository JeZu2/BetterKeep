<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task List with Root‐Level Drop Target</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    ul {
      list-style: none;
      padding-left: 1em;
      margin: 0;
      transition: outline 0.2s ease;
    }
    /* Root‐level drop highlight */
    #checkbox-tree.root-drag-over {
      outline: 2px dashed #0066cc;
    }
    /* Give list items more “air” */
    li {
      margin: 8px 0;
      padding: 8px;
      border-radius: 4px;
    }
    li.dragging {
      opacity: 0.4;
    }
    li.drag-over {
      outline: 2px dashed #0066cc;
    }
    /* Larger, touch‐friendly labels & checkboxes */
    li > label {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }
    li > label input[type="checkbox"] {
      transform: scale(1.8);
      margin-right: 12px;
    }
    .btn {
      margin-left: 8px;
      padding: 6px 12px;
      font-size: 16px;
      border: 1px solid #888;
      background: #f0f0f0;
      border-radius: 3px;
      cursor: pointer;
    }
    .btn:hover {
      background: #e0e0e0;
    }
    /* Done section styling */
    #done-section li label {
      text-decoration: line-through;
      color: #555;
      cursor: default;
    }
    #done-section li .add-btn,
    #done-section li .remove-btn {
      display: none;
    }
    #done-section li {
      cursor: default;
    }
  </style>
</head>
<body>

  <h2>Task List</h2>
  <button id="add-root-btn" class="btn" style="margin-bottom:16px;">
    + Add Task
  </button>

  <ul id="checkbox-tree">
    <li>
      <label><input type="checkbox" /> Fruits</label>
      <button class="btn add-btn">+</button>
      <button class="btn remove-btn">−</button>
      <ul>
        <li>
          <label><input type="checkbox" /> Citrus</label>
          <button class="btn add-btn">+</button>
          <button class="btn remove-btn">−</button>
          <ul></ul>
        </li>
      </ul>
    </li>
  </ul>

  <h3>Done</h3>
  <ul id="done-section"></ul>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tree = document.getElementById('checkbox-tree');
      const done = document.getElementById('done-section');
      const addRootBtn = document.getElementById('add-root-btn');
      let dragItem = null, dragSrc = null;
      let idCount = 0, loc = {};

      function giveId(li) {
        if (!li.id) li.id = 't-' + (idCount++);
      }

      // Initial IDs
      tree.querySelectorAll('li').forEach(giveId);

      function updateChildren(chk, val) {
        chk.closest('li')
           .querySelectorAll('ul input[type=checkbox]')
           .forEach(c => { c.checked = val; c.indeterminate = false; });
      }
      function updateParents(chk) {
        const pLi = chk.closest('ul')?.closest('li');
        if (!pLi) return;
        const pChk = pLi.querySelector('> label input[type=checkbox]');
        const kids = [...pLi.querySelectorAll('ul>li>label>input[type=checkbox]')];
        const all = kids.every(c => c.checked && !c.indeterminate);
        const none = kids.every(c => !c.checked && !c.indeterminate);
        if (all) { pChk.checked = true; pChk.indeterminate = false; }
        else if (none) { pChk.checked = false; pChk.indeterminate = false; }
        else { pChk.checked = false; pChk.indeterminate = true; }
        updateParents(pChk);
      }
      function moveDone(li) {
        const pu = li.parentElement, ns = li.nextElementSibling;
        loc[li.id] = { pu, ns };
        li.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = true);
        done.appendChild(li);
      }
      function moveOrig(li) {
        const info = loc[li.id];
        if (!info) return tree.appendChild(li);
        const { pu, ns } = info;
        li.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
        if (ns && pu.contains(ns)) pu.insertBefore(li, ns);
        else pu.appendChild(li);
      }

      function reinit() {
        tree.querySelectorAll('li').forEach(giveId);
        done.querySelectorAll('li').forEach(giveId);
        tree.querySelectorAll('li').forEach(li => li.draggable = true);
        done.querySelectorAll('li').forEach(li => li.draggable = false);

        // Checkboxes
        document.querySelectorAll('input[type=checkbox]').forEach(chk => {
          const n = chk.cloneNode();
          chk.replaceWith(n);
          n.addEventListener('change', () => {
            const li = n.closest('li');
            if (n.checked && li.closest('#checkbox-tree')) moveDone(li);
            else if (!n.checked && li.closest('#done-section')) moveOrig(li);
            reinit();
          });
        });

        // Add/remove
        tree.querySelectorAll('.add-btn').forEach(b => {
          const nb = b.cloneNode(true); b.replaceWith(nb);
          nb.addEventListener('click', e => {
            e.stopPropagation();
            const p = nb.closest('li');
            const name = prompt('New task:', '').trim();
            if (!name) return;
            const li = document.createElement('li');
            giveId(li);
            li.innerHTML = `
              <label><input type="checkbox" /> ${name}</label>
              <button class="btn add-btn">+</button>
              <button class="btn remove-btn">−</button>
              <ul></ul>`;
            let u = p.querySelector('ul');
            if (!u) { u = document.createElement('ul'); p.appendChild(u); }
            u.appendChild(li);
            reinit();
          });
        });
        tree.querySelectorAll('.remove-btn').forEach(b => {
          const nb = b.cloneNode(true); b.replaceWith(nb);
          nb.addEventListener('click', e => {
            e.stopPropagation();
            const li = nb.closest('li');
            if (!confirm('Delete this task and all subtasks?')) return;
            const pu = li.parentElement;
            li.remove();
            if (pu.children.length === 0) pu.remove();
            reinit();
          });
        });
      }

      // Root-level add
      addRootBtn.addEventListener('click', () => {
        const name = prompt('Enter new top-level task:', '').trim();
        if (!name) return;
        const li = document.createElement('li');
        giveId(li);
        li.innerHTML = `
          <label><input type="checkbox" /> ${name}</label>
          <button class="btn add-btn">+</button>
          <button class="btn remove-btn">−</button>
          <ul></ul>`;
        tree.appendChild(li);
        reinit();
      });

      reinit();

      // Shared move logic
      function doMove(over, x, y) {
        const dropOnLabel = !!document.elementFromPoint(x, y)?.closest('li>label');
        const rect = over.getBoundingClientRect();
        const mid = rect.top + rect.height / 2;

        // remove any root highlight
        tree.classList.remove('root-drag-over');

        if (over === tree) {
          // dropped on empty root
          tree.appendChild(dragItem);
        }
        else if (dragSrc === done) {
          // reorder in done
          if (y < mid) done.insertBefore(dragItem, over);
          else done.insertBefore(dragItem, over.nextSibling);
        }
        else {
          // reorder/nest in tree
          if (dropOnLabel) {
            let u = over.querySelector('ul');
            if (!u) { u = document.createElement('ul'); over.appendChild(u); }
            u.appendChild(dragItem);
          }
          else if (y < mid) over.parentNode.insertBefore(dragItem, over);
          else over.parentNode.insertBefore(dragItem, over.nextSibling);
        }
        reinit();
      }

      // Mouse drag/drop
      [tree, done].forEach(list => {
        list.addEventListener('dragstart', e => {
          dragItem = e.target.closest('li');
          if (!dragItem) return;
          dragSrc = dragItem.closest('ul');
          dragItem.classList.add('dragging');
        });
        list.addEventListener('dragend', e => {
          if (dragItem) {
            dragItem.classList.remove('dragging');
            dragItem = null;
          }
          tree.classList.remove('root-drag-over');
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        });
        list.addEventListener('dragover', e => {
          e.preventDefault();
          const overLi = e.target.closest('li');
          if (overLi && overLi !== dragItem) {
            overLi.classList.add('drag-over');
          }
          else if (!overLi && list === tree) {
            // hovering over empty root
            tree.classList.add('root-drag-over');
          }
        });
        list.addEventListener('dragleave', e => {
          const overLi = e.target.closest('li');
          if (overLi) overLi.classList.remove('drag-over');
          else if (list === tree) tree.classList.remove('root-drag-over');
        });
        list.addEventListener('drop', e => {
          e.preventDefault();
          const overLi = e.target.closest('li');
          if (overLi && overLi !== dragItem) {
            overLi.classList.remove('drag-over');
            doMove(overLi, e.clientX, e.clientY);
          }
          else if (!overLi && list === tree) {
            // drop at root
            doMove(tree, e.clientX, e.clientY);
          }
        });
      });

      // Touch drag/drop on tree only
      tree.addEventListener('touchstart', e => {
        const li = e.target.closest('li');
        if (!li) return;
        dragItem = li;
        dragSrc = li.closest('ul');
        li.classList.add('dragging');
      }, { passive: false });

      tree.addEventListener('touchmove', e => {
        if (!dragItem) return;
        e.preventDefault();
        tree.classList.remove('root-drag-over');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        const t = e.touches[0];
        const under = document.elementFromPoint(t.clientX, t.clientY);
        const overLi = under?.closest('li');
        if (overLi && overLi !== dragItem) {
          overLi.classList.add('drag-over');
        } else {
          tree.classList.add('root-drag-over');
        }
      }, { passive: false });

      tree.addEventListener('touchend', e => {
        if (!dragItem) return;
        const t = e.changedTouches[0];
        const under = document.elementFromPoint(t.clientX, t.clientY);
        const overLi = under?.closest('li');
        if (overLi && overLi !== dragItem) {
          doMove(overLi, t.clientX, t.clientY);
        } else {
          doMove(tree, t.clientX, t.clientY);
        }
        dragItem.classList.remove('dragging');
        dragItem = null;
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        tree.classList.remove('root-drag-over');
      });

    });
  </script>
</body>
</html>
