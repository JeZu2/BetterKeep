<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BetterKeep</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    ul { list-style: none; padding-left: 1em; margin: 0; transition: outline 0.2s ease; }
    #checkbox-tree.root-drag-over { outline: 2px dashed #0066cc; }
    li { margin: 8px 0; padding: 8px; border-radius: 4px; }
    li.dragging { opacity: 0.4; }
    li.drag-over { outline: 2px dashed #0066cc; }
    li > label { display: inline-flex; align-items: center; cursor: pointer; font-size: 18px; padding: 4px; }
    li > label input[type="checkbox"] { transform: scale(1.8); margin-right: 12px; }
    .btn { margin-left: 8px; padding: 6px 12px; font-size: 16px; border: 1px solid #888; background: #f0f0f0; border-radius: 3px; cursor: pointer; }
    .btn:hover { background: #e0e0e0; }
    #done-section li label { text-decoration: line-through; color: #555; cursor: default; }
    #done-section li .add-btn, #done-section li .remove-btn { display: none; }
    #done-section li { cursor: default; }
    @media (max-width: 600px) {
      li > label { font-size: 30px; padding: 10px; }
      li > label input[type="checkbox"] { transform: scale(3); margin-right: 30px; }
      .btn { padding: 10px 16px; font-size: 24px; }
      h2, h3 { font-size: 1.5em; }
    }
  </style>
</head>
<body>

  <h2>Task List</h2>
  <button id="add-root-btn" class="btn" style="margin-bottom:16px;">+ Add Task</button>
  <ul id="checkbox-tree"></ul>

  <h3>Done</h3>
  <ul id="done-section"></ul>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let tree = document.getElementById('checkbox-tree');
      const done = document.getElementById('done-section');
      const addRootBtn = document.getElementById('add-root-btn');
      let idCount = 0;

      function giveId(li) {
        if (!li.id) li.id = 't-' + (idCount++);
      }

      function serializeList(ul, doneStatus = false) {
        return Array.from(ul.children).map(li => {
          const checkbox = li.querySelector('label input[type=checkbox]');
          const label = li.querySelector('label');
          const text = label.textContent.trim();
          const children = li.querySelector('ul') ? serializeList(li.querySelector('ul'), doneStatus) : [];
          return {
            text,
            checked: checkbox.checked,
            done: doneStatus,
            children
          };
        });
      }

      function saveData() {
        const tasks = [
          ...serializeList(tree, false),
          ...serializeList(done, true)
        ];
        localStorage.setItem('taskData', JSON.stringify(tasks));
      }

      function buildList(items, parentUl) {
        for (const item of items) {
          const li = document.createElement('li');
          giveId(li);
          li.innerHTML = `
            <label><input type="checkbox" ${item.checked ? 'checked' : ''} /> ${item.text}</label>
            <button class="btn add-btn">+</button>
            <button class="btn remove-btn">−</button>
            <ul></ul>`;
          buildList(item.children, li.querySelector('ul'));
          parentUl.appendChild(li);
        }
      }

      function loadData() {
        const data = JSON.parse(localStorage.getItem('taskData') || '[]');
        tree.innerHTML = '';
        done.innerHTML = '';
        const activeTasks = data.filter(task => !task.done);
        const doneTasks = data.filter(task => task.done);
        buildList(activeTasks, tree);
        buildList(doneTasks, done);
      }

      function rebindEvents() {
        document.querySelectorAll('input[type=checkbox]').forEach(chk => {
          chk.addEventListener('change', () => {
            const li = chk.closest('li');
            if (chk.checked && tree.contains(li)) {
              done.appendChild(li);
              chk.checked = true;
            } else if (!chk.checked && done.contains(li)) {
              tree.appendChild(li);
              chk.checked = false;
            }
            rebindEvents();
            saveData();
          });
        });

        document.querySelectorAll('.add-btn').forEach(btn => {
          btn.onclick = () => {
            const taskName = prompt('Subtask name:');
            if (!taskName) return;
            const parentLi = btn.closest('li');
            const subUl = parentLi.querySelector('ul');
            const li = document.createElement('li');
            giveId(li);
            li.innerHTML = `
              <label><input type="checkbox" /> ${taskName}</label>
              <button class="btn add-btn">+</button>
              <button class="btn remove-btn">−</button>
              <ul></ul>`;
            subUl.appendChild(li);
            rebindEvents();
            saveData();
          };
        });

        document.querySelectorAll('.remove-btn').forEach(btn => {
          btn.onclick = () => {
            if (!confirm('Delete this task and its subtasks?')) return;
            const li = btn.closest('li');
            li.remove();
            saveData();
          };
        });
      }

      addRootBtn.onclick = () => {
        const taskName = prompt('New task name:');
        if (!taskName) return;
        const li = document.createElement('li');
        giveId(li);
        li.innerHTML = `
          <label><input type="checkbox" /> ${taskName}</label>
          <button class="btn add-btn">+</button>
          <button class="btn remove-btn">−</button>
          <ul></ul>`;
        tree.appendChild(li);
        rebindEvents();
        saveData();
      };

      loadData();
      rebindEvents();
    });
  </script>
</body>
</html>
